<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streckenkarte // LA-Strecken</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .popup-content {
            font-family: Arial, sans-serif;
            font-size: 14px;
            line-height: 1.5;
        }

        .popup-content b {
            color: #2c3e50;
            font-size: 16px;
        }

        .popup-content span {
            display: block;
            margin-top: 4px;
        }
    </style>
</head>
<body>
<div id="map"></div>
<script>
    const map = L.map('map').setView([48.99342, 8.40187], 14);
    let elements = [];
    let layerLa;

    document.addEventListener('DOMContentLoaded', function () {
        layerLa = L.layerGroup();

        let layerControl = L.control.layers().addTo(map);

        let base = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);
        layerControl.addBaseLayer(base, "Hintergrundkarte");

        let orm = L.tileLayer('https://{s}.tiles.openrailwaymap.org/standard/{z}/{x}/{y}.png', {
            attribution: '© OpenRailwayMap contributors'
        });
        layerControl.addOverlay(orm, "Infrastruktur");

        let ormSpeed = L.tileLayer('https://{s}.tiles.openrailwaymap.org/maxspeed/{z}/{x}/{y}.png', {
            attribution: '© OpenRailwayMap contributors'
        });
        layerControl.addOverlay(ormSpeed, "Geschwindigkeitsbegrenzungen");

        layerControl.addOverlay(layerLa, "LA Strecken");
        layerLa.addTo(map);

        map.locate({setView: true, maxZoom: 16});

        refreshMap();

        map.on('moveend', function () {
            refreshMap();
        });
        map.on('zoomend', function () {
            refreshMap();
        });
    });

    function refreshMap() {
        if (!map) {
            return;
        }
        if (map.getZoom() < 12) {
            return;
        }

        const bbox = map.getBounds();
        let bboxString = bbox._southWest.lat + ',' + bbox._southWest.lng + ',' + bbox._northEast.lat + ',' + bbox._northEast.lng;

        const query = encodeURIComponent('[out:json][timeout:5];(way["railway"]["ref:La"](') + bboxString + encodeURIComponent('););out geom;');
        fetch('https://overpass-api.de/api/interpreter?data=' + query)
            .then(response => response.json())
            .then(data => {
                if (!data.elements) {
                    return;
                }
                data.elements.forEach(element => {
                    if (elements.includes(element.id)) {
                        return;
                    }
                    elements.push(element.id);

                    let latlngs = [];
                    element.geometry.forEach(geom => {
                        latlngs.push([geom.lat, geom.lon]);
                    });

                    let popupContent = `<div class="popup-content">
                        <b>LA-Strecke ${element.tags['ref:La']}</b>
                        ${element.tags.ref ? `<span>Strecke: ${element.tags.ref}</span>` : ''}
                        ${element.tags.name ? `<span>Name: ${element.tags.name}</span>` : ''}
                        ${element.tags.operator ? `<span>Betreiber: ${element.tags.operator}</span>` : ''}

                        <a href="https://www.openstreetmap.org/way/${element.id}" target="_blank">In OSM anzeigen</a>
                    </div>`;

                    L.polyline(latlngs, {
                        color: generateColorFromAttribute(element.tags['ref:La']),
                        weight: 5,
                        opacity: 0.7,
                        lineJoin: 'round',
                        lineCap: 'round',
                    })
                        .bindPopup(popupContent)
                        .addTo(layerLa);
                });
            });
    }

    function generateColorFromAttribute(attribute) {
        attribute = attribute + "LA" + attribute; // make sure we have at least 3 characters
        let hash = 0;
        for (let i = 0; i < attribute.length; i++) {
            hash = attribute.charCodeAt(i) + ((hash << 5) - hash);
        }
        let c = (hash & 0x00FFFFFF)
            .toString(16)
            .toUpperCase();
        return '#' + "00000".substring(0, 6 - c.length) + c;
    }
</script>
</body>
</html>
